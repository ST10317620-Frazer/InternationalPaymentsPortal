version: 2.1

jobs:
  security-build:
    docker:
      - image: node:18
    steps:
      - checkout

      # Backend install
      - run:
          name: Install Backend Dependencies
          command: |
            cd backend
            npm install

      # Dependency vulnerability scanning
      - run:
          name: Dependency Vulnerability Scan
          command: |
            cd backend
            npm run audit

      # Start API in background
      - run:
          name: Start API Server
          command: |
            cd backend
            npm start &
            sleep 10

      # API security / availability test
      - run:
          name: API Health Check
          command: |
            curl --fail http://localhost:5000/api/health

      # Frontend install
      - run:
          name: Install Frontend Dependencies
          command: |
            cd frontend
            npm install

workflows:
  devsecops-pipeline:
    jobs:
      - security-build